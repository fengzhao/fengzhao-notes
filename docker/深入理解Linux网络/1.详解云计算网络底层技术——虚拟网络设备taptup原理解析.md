





在云计算时代，虚拟机和容器已经成为标配。

它们背后的网络管理都离不开一样东西，就是虚拟网络设备，或者叫虚拟网卡，tap/tun 就是在云计算时代非常重要的虚拟网络网卡。







## TAP/TUN



在计算机网络中，TUN与TAP是操作系统内核中的虚拟网络设备。tap/tun 是 Linux Kernel 2.4.x 版本之后实现的虚拟网络设备。

不同于物理网卡靠硬件网路板卡实现的设备。tap/tun 虚拟网卡完全由软件来实现，功能和硬件实现完全没有差别，等同于网络设备，都可以配置 IP，都归 Linux 网络设备管理模块统一管理。

作为网络设备，它操作第二层数据包如以太网数据帧。tap/tun 也需要配套相应的驱动程序才能工作。tap/tun 驱动程序包括两个部分，一个是字符设备驱动，一个是网卡驱动。

这两部分驱动程序分工不太一样P: 

- **字符驱动**负责数据包在内核空间和用户空间的传送。写入字符设备`/dev/net/tun`的数据会发送到虚拟网络接口中；
- **网卡驱动**负责数据包在 TCP/IP 网络协议栈上的传输和处理。发送到虚拟网络接口中的数据也会出现在该字符设备上。



在云原生虚拟网络中， flannel 的 UDP 模式中的 `flannel0` 就是一个 tun 设备，`OpenVPN` 也利用到了 tun/tap 进行数据的转发。

应用程序可以通过标准的`Socket API`向TUN/TAP接口发送IP数据包，就好像对一个真实的网卡进行操作一样。



不同于普通靠硬件网路板卡实现的设备，这些虚拟的网络设备全部用软件实现，并向运行于操作系统上的软件提供与硬件的网络设备完全相同的功能。

TAP等同于一个以太网设备，TUN模拟了网络层设备，操作第三层数据包比如IP数据封包。

操作系统通过TUN/TAP设备向绑定该设备的用户空间的程序发送数据，反之，用户空间的程序也可以像操作硬件网络设备那样，通过TUN/TAP设备发送数据。在后种情况下，TUN/TAP设备向操作系统的网络栈投递（或“注入”）数据包，从而模拟从外部接受数据的过程。



## veth

veth 是另一种主流的虚拟网卡方案，在 Linux Kernel 2.6 版本，Linux 开始支持网络名空间隔离的同时。

也提供了专门的虚拟以太网（Virtual Ethernet，习惯简写做 veth）让两个隔离的网络名称空间之间可以互相通信。



veth 实际上不是一个设备，而是一对设备，因而也常被称作 Veth-Pair。

Docker 中的 Bridge 模式就是依靠 veth-pair 连接到 docker0 网桥上与宿主机乃至外界的其他机器通信的。





## 虚拟机交换机/网桥

在物理机的网络环境中，多台不同的物理机之间是如何连接一起互相通信的呢？ 没错，那就是以太网交换机。同一网络内的多台物理机通过交换机连在一起，然后它们就可以相互通信了。



在网络虚拟化环境里，和物理网络中的交换机一样，也需要这样的一个软件实现的设备。它需要有很多个虚拟端口，能把更多的虚拟网卡连接在一起，通过自己的转发功能让这些虚拟网卡之间可以通信。 



在 Linux 下这个软件实现交换机的技术就叫做 bridge（再强调下，这是纯软件实现的）。

同 tap/tun、veth-pair 一样，Bridge 也是一种虚拟网络设备，所以具备虚拟网络设备的所有特性，比如可以配置 IP、MAC 等。除此之外，Bridge 还是一个交换机，具有交换机所有的功能。



在安装Docker默认环境中，一个名为``的 `Linux bridge`自动被创建好了，其上有一个 `docker0` 内部接口，IP地址为172.17.0.1/16

用 `docker network inspect bridge`指令查看 这个`bridge`网络：其Gateway就是网卡/接口docker0的IP地址：172.17.0.1。

每次创建一个新容器的时候，Docker 从可用的地址段中选择一个空闲的 IP 地址分配给容器的 `eth0` 端口。使用本地主机上 `docker0` 接口的 IP 作为所有容器的默认网关。



## 用户空间与内核空间的数据传输



在 Linux 中，用户空间和内核空间的数据传输有多种方式，字符设备就是其中的一种。

tap/tun 通过驱动程序和一个与之关联的字符设备，来实现用户空间和内核空间的通信接口。