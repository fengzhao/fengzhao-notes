# DHCP协议



在常见的小型网络中（例如家庭网络和学生宿舍网），网络管理员都是采用手工分配IP地址的方法，而到了中、大型网络，这种方法就不太适用了。

在中、大型网络，特别是大型网络中，往往有超过100台的客户机，手动分配IP地址的方法就不太合适了。

因此，我们必须引入一种高效的IP地址分配方法，幸好，DHCP（Dynamic Host Configuration Protocol）为我们解决了这一难题。





DHCP是一种应用层协议，建立在 UDP 协议之上。

动态主机配置协议DHCP（Dynamic Host Configuration Protocol）是一种用于集中对用户IP地址进行动态管理和配置的协议。

通常被应用在大型的局域网络环境中。

DHCP采用**==客户端/服务器==**通信模式，由客户端向服务器提出配置申请，服务器返回为客户端分配的IP地址等相应的配置信息，以实现IP地址等信息的动态配置。

当DHCP服务器接收到来自网络主机申请地址的信息时，才会向网络主机发送相关的地址配置等信息，以实现网络主机地址信息的动态配置。



它的主要作用是集中的管理、分配IP地址，使网络环境中的主机动态的获得IP地址、Gateway地址、DNS服务器地址等信息，并能够提升地址的使用率。



## **目的**

连接到Internet的每台计算机需要在发送或接收数据报文前知道其IP地址。



具有本地磁盘的系统引导时，一般是从磁盘上的配置文件中读取 I P地址。但是无盘机，如X终端或无盘工作站，则需要采用其他方法来获得 IP 地址。

在 1980 年代，早期一些**无盘工作站（diskless workstations）** 启动时： 

- 没有硬盘，无法存储 IP 配置；
- 但知道自己的 **MAC 地址**（固化在网卡中）；
- 需要从网络中获取自己的 **IP 地址** 才能通信。

于是 RARP 被提出（定义于 **RFC 903，1984 年**），允许这类设备广播自己的 MAC 地址，请求 RARP 服务器返回对应的 IP 地址。 



RARP 工作原理 

1. **客户端（无盘工作站）**： 
   - 在本地网络**广播请求** 一个 **RARP 请求**，内容为：“我的 MAC 是 AA:BB:CC:DD:EE:FF，谁告诉我我的 IP 是多少？”
2. **RARP 服务器**： 
   - 必须预先在服务器上配置好 **MAC 地址 ↔ IP 地址** 的映射表（类似静态 DHCP 绑定）；
   - 收到请求后，若匹配到该 MAC，就**单播回复**对应的 IP 地址。
3. **客户端收到响应**后，即可使用该 IP 地址进行后续网络通信。 

> 📌 RARP **仅工作在本地局域网（L2 广播域）**，不能跨路由器（因为广播无法穿越三层）。 



另外，计算机还需要其他信息，如路由器的地址、使用的子网掩码和DNS名字服务器的地址等。

BOOTP协议（BOOTSTRAP PROTOCOL）是一种较早出现的远程启动的协议，主要用于无磁盘的客户机从服务器得到自己的IP地址、服务器的IP地址、启动映象文件名、网关IP等等。

BOOTP设计用于相对静态的环境，其中每台主机都有一个永久的网络连接。



随着网络规模的扩大和网络复杂度的提高，网络配置变的越来越复杂，在计算机经常移动（如便携机或无线网络）和计算机的数量超过可分配的IP地址等情况下，原有针对静态主机配置的BOOTP协议已经越来越不能满足实际需求。

为方便用户快速地接入和退出网络、提高IP地址资源的利用率以及支持无盘网络工作站等应用，需要在BOOTP基础上制定一种自动机制来进行IP地址的分配。





## DHCP 的组件

使用 DHCP 时，了解所有的组件很重要，下面我为你列出了一些 DHCP 的组件和它们的作用都是什么

- `DHCP Server`：**DHCP 服务器**，负责处理来自客户端或中继的地址分配、地址续租、地址释放等请求，为客户端分配IP地址和其他网络配置信息。

- `DHCP Client`：**DHCP 客户端**，通过与DHCP服务器进行报文交互，获取IP地址和其他网络配置信息，完成自身的地址配置。

  - 在设备接口上配置DHCP Client功能，这样接口可以作为DHCP Client，使用DHCP协议从DHCP Server动态获得IP地址等参数，方便用户配置，也便于集中管理。
  - DHCP 的客户端可以是==**计算机、移动设备或者其他需要连接到网络的任何设备，默认情况下，大多数配置为接收 DHCP 信息**。==

- `DHCP Relay`：**DHCP中继**，负责转发来自客户端方向或服务器方向的DHCP报文，协助DHCP客户端和DHCP服务器完成地址配置功能。

  - 如果DHCP服务器和DHCP客户端不在同一个网段范围内，则需要通过DHCP中继来转发报文，这样可以避免在每个网段范围内都部署DHCP服务器，既节省了成本，又便于进行集中管理。
  - DHCP 中继器通常应对 DHCP 服务器和 DHCP 客户端不再同一个网段的情况，如果 DHCP 服务器和 DHCP 客户端在同一个网段下，那么客户端可以正确的获得动态分配的 IP 地址；如果不在的话，就需要使用 DHCP 中继器进行中继代理。

- `Ip address pool`: 你得有 IP 地址池啊，虽然说你 DHCP 提供服务，但是你也得有工具啊，没有工具玩儿啥？IP 地址池是 DHCP 客户端可用的地址范围，这个地址范围通常由最低 -> 最高顺序发送。

- `Subnet`：这个组件是子网，IP 网络可以划分一段一段的子网，子网更有助于网络管理。

- `Lease`：租期，这个表示的就是 IP 地址续约的期限，同时也代表了客户端保留 IP 地址信息的时间长度，一般租约到期时，客户端必须续约。

- `DHCP relay`：DHCP 中继器，这个一般比较难想到，DHCP 中继器一般是路由器或者主机。

  

**DHCP服务器**

DHCP 服务器会维护 IP 地址池，在网络上启动时会将地址租借给启用 DHCP 的客户端。

由于 IP 地址是**动态的(临时分配)**而不是**静态的(永久分配)**，因此不再使用的 IP 地址会自动返回 IP 地址池中进行重新分配。

> 那么 DHCP 服务器由谁维护呢？

网络管理员负责建立 DHCP 服务器，并以**==租约==**的形式向启用 DHCP 的客户端提供地址配置，啊，既然不需要我管理，那就很舒服了～

好了，现在你能舒舒服服的开发了，你用 postman 配了一条 192.168.1.4/x/x 的接口进行请求，请求能够顺利进行，但是过了一段时间后，你发现 192.168.1.4/x/x 这个接口请求不通了，这是为啥呢？

然后你用 `ipconfig` 查询了一下自己的 IP 地址，发现 IP 地址变成了 192.168.1.7，怎么我用着用着 IP 地址还改了？DHCP 是个垃圾，破玩意！！@#¥%¥%……¥%

其实，这也是一个 DHCP 服务器的一个功能，DHCP 服务器通常为每个客户端分配一个**唯一的动态 IP 地址**，当该 IP 地址的**客户端租约到期**时，该地址就会更改。



唯一意思说的就是，如果你手动设置了一个静态 IP，同时 DHCP 服务器分配了一个动态 IP，这个动态 IP 和静态 IP 一样，那么必然会有一个客户端无法上网。

> 我就遇到过这种情况，我使用虚拟机配置的静态 IP 是192.168.1.8，手机使用 DHCP 也同样配置了 192.168.1.8 的 IP 地址，此时我的虚拟机还没有接入网络，当我接入网络时，我怎样也连不上虚拟机了，一查才发现 IP 地址冲突了 ......

虽然 DHCP 服务器能提供 IP 地址，但是他怎么知道哪些 IP 地址空闲，哪些 IP 地址正在使用呢？



实际上，这些信息都配置在了`数据库`中，下面我们就来一起看一下 DHCP 服务器维护了哪些信息。

- 网络上所有有效的 TCP/IP 配置参数

这些参数主要包括**主机名（Host name）、DHCP 客户端（DHCP client）、域名（Domain name）、IP 地址IP address）、网关（Netmask）、广播地址（Broadcast address）、默认路由（default rooter）**。

- 有效的 IP 地址和排除的 IP 地址，保存在 IP 地址池中等待分配给客户端
- 为某些特定的 DHCP 客户端保留的地址，这些地址是静态 IP，这样可以将单个 IP 地址一致地分配给单个DHCP 客户端

好了，现在你知道 DHCP 服务器都需要保存哪些信息了，并且看过上面的内容，你应该知道一个 DHCP 的组件有哪些了，下面我们就来聊一聊 DHCP 中都有哪些组件，这些组件缺一不可。





## DHCP 报文



DHCP 报文共有一下几种类型：

- **DHCP DISCOVER** ：客户端开始 DHCP 过程发送的包，是 DHCP 协议的开始。

  - **==DHCP客户端首次登录网络时进行DHCP交互过程发送的第一个消息，用来寻找DHCP服务器。==**

- **DHCP OFFER** ：服务器接收到 `DHCPDISCOVER` 之后做出的响应，它包括了给予客户端的 IP 租约过期时间、服务器的识别符以及其他信息。

  - DHCP 响应报文（DHCPOFFER）本质上是一个**应用层协议**，使用 **UDP** 在传输层传输，并依赖 **IP** 和 **MAC** 地址进行寻址。
    - 应用层：**DHCPOFFER 报文**，包含 IP **租约过期时间**、**拟分配的 IP 地址**、**服务器标识符**（服务器 IP）、子网掩码、网关等配置信息。
    - 传输层：使用 **UDP 封装**。与 Discover 报文相反，服务器从 67 端口发出，发送给客户端的 68 端口。
    - 网络层：**源 IP：DHCP 服务器的 IP 地址** (例如 192.168.1.1)；**目的 IP：255.255.255.255** (**广播地址**)。此时客户端尚未配置 IP，因此服务器通常使用 **广播** 发送 Offer 报文，确保所有客户端都能收到，但客户端会根据报文内的事务 ID (Transaction ID) 识别是否是发给自己的。*（少数情况下服务器可能直接发送给客户端的 MAC 地址，但广播是最常见方式。）*
    - 

- **DHCP REQUEST** ：客户端对于服务器发出的 `DHCPOFFER` 所做出的响应。在续约租期的时候同样会使用。在如下场景都会发送这种包：

  - **==客户端初始化后==**，发送广播的`DHCP REQUEST`消息来回应服务器的`DHCP OFFER`消息。
  - 客户端重启初始化后，发送广播的`DHCP REQUEST`消息来确认先前被分配的IP地址等配置信息。
  - 客户端已经和某个IP地绑定后，发送`DHCP REQUEST`消息来更新IP地址的租约。
  - 

- **DHCP ACK** ：服务器在接收到客户端发来的 `DHCPREQUEST` 之后发出的成功确认的报文。**==客户端在接收到这个报文之后才会确认分配给它的 IP 和其他信息可以被允许使用。==**

- **DHCP NAK** ：DHCP ACK 的相反的报文，表示服务器拒绝了客户端的请求。告知DHCP客户端无法分配合适IP地址。

- **DHCP DECLINE** :当客户端发现服务器分配的 IP 地址无法使用（如 IP 地址冲突时）。将发出此报文通知服务器，并且会重新向服务器申请地址。

- **DHCP RELEASE** ：一般出现在客户端关机、下线等状况。这个报文将会使 DHCP 服务器释放发出此报文的客户端的 IP 地址

- **DHCP INFORM** ：DHCP客户端获取IP地址后，如果需要向DHCP服务器获取更为详细的配置信息（网关地址、DNS服务器地址），则向DHCP服务器发送DHCP-INFORM请求消息。

  

  
  
  
  
  

# DHCP工作机制

DHCP 的工作机制比较简单：

DHCP客户端向DHCP服务器动态地请求网络配置信息，DHCP服务器根据策略返回相应的配置信息（IP地址、子网掩码、缺省网关等网络参数）。

客户端和服务器之间交互的消息格式由固定格式的首部和可变的选项格式区域组成。



**（一）发现阶段**

当主机刚刚开机运行，此时它不知道此时网络中是否存在DHCP服务器，DHCP服务器是谁，因此它必须首先确定网络中的DHCP服务器身份。

因此，**==新上线主机会发送一个 DHCP Discover 报文， 该报文是一个广播报文，源IP地址为0.0.0.0，目的IP地址为255.255.255.255。==**

源MAC地址为自己的MAC地址，目的MAC地址为 `FFFF-FFFF-FFFF`

该报文会**==在二层网络中广播洪泛==**，因此如果网络中存在DHCP服务器，则DHCP服务器会收到该报文。

数据封装过程大致如下：

- 应用层：`DHCP Discover` 报文。**==客户端向网络发出请求，要求获取 IP 地址及配置信息。==**
- 传输层：使用 **UDP 封装**。客户端源端口是 **68**，目的端口是 **67**（DHCP 服务器端口）
- 网络层：IP头部，客户端不知道自己的 IP，所以 **源 IP** 是 **0.0.0.0**。客户端不知道服务器 IP，所以 **目的 IP** 是 **255.255.255.255**（**三层广播地址**）
- 数据链路层：客户端不知道 DHCP 服务器的 MAC 地址，所以 **目的 MAC 地址** 是 **FFFF.FFFF.FFFF**（**二层广播地址**）

注意：这个目的IP其实是受限的三层广播地址。路由器**绝对不会**转发目的地址为 `255.255.255.255` 的数据包。它被限制在发送者所在的同一个二层广播域内。







**（二）提供阶段**

当网络中的DHCP服务器收到了`DHCP Client`发送的DHCP报文后，DHCP就进入了提供阶段。

在这个阶段，`DHCP Server`会根据管理员的相关配置，给`DHCP Client`提供一个可用的IP地址，同时给其提供DNS、子网掩码等信息。

==**响应一个 DHCP Offer 报文，`DHCP Server`会发送`DHCP Offer`信息给`DHCP Client`提供上述信息，该报文也是一个广播报文**。==

> 很多 DHCP 服务器（尤其是企业级和遵循严格标准的服务器）在发送 `DHCPOFFER` 之前，会采取措施进行 IP 地址冲突检测，其中最常见的方法之一就是发送 **ARP 广播**。

数据封装大致过程如下：

- 应用层：`DHCP OFFER` 报文。**==有字段标识这是Offer类型==**

- 传输层：使用 **UDP 封装**。数据从服务端发出，源端口是 **67**（DHCP服务器），目的端口是 **68**（客户端电脑）
- 网络层：源为DHCP服务器IP，目的IP地址为DHCP Server给该DHCP Client分配的IP地址。
- 数据链路层：源MAC地址为DHCP Server的MAC地址，目的MAC地址为DHCP Client的MAC地址。

（注，在这里有的设备上DHCP Offer报文也是广播，其实也能够实现DHCP的功能）



**（三）请求阶段**

在`DHCP Client`收到DHCP Server发送的DHCP Offer报文后，就进入了DHCP请求阶段。

在DHCP请求阶段，DHCP Client已经得到了DHCP Server分配给它的IP地址，DHCP Client在得到该IP地址后，却不会马上使用。

**==DHCP Client会向DHCP Server发送DHCP Request报文，来正式向DHCP Server申请使用该IP地址。==**



数据封装大致过程如下：

- 应用层：`DHCP OFFER` 报文。**==有字段标识这是Request类型==**
- 传输层：使用 **UDP 封装**。数据又从服务端发出，源端口是 **68**（客户端电脑），目的端口是 **67**（DHCP服务器）

- 网络层：

  - 源IP地址为0.0.0.0（因为这时还没有得到DHCP服务器的回应，因此此时这个IP地址还不能正常使用，因此在这里源IP地址还是0.0.0.0）。

  - 目的地址为255.255.255.255。（注：在这里其实DHCP Client其实已经知道了DHCP Server的IP地址，因此其实这里使用DHCP Server的IP地址其实也是可以的.

因此，有些设备对此做了优化，因为这样可以减少网络中的广播洪范流量）

- 源MAC和目的MAC地址分别是DHCP Client的和DHCP Server的MAC地址。



**（四）确认阶段**

当DHCP Server收到DHCP Client发送的DHCP Request报文后，DHCP进入确认阶段。DHCP Server会向DHCP Client发送DHCP Reply报文，表示同意DHCP Client使用该IP地址。

DHCP Reply 报文（有时也被称为DHCP ACK报文），源IP地址为DHCP Server的IP地址，目的IP地址为DHCP Client的IP地址，源目MAC为DHCP Server和Client的MAC地址。



### 重启PC后的DHCP过程及DHCP续约机制



目前，PC机对于DHCP有记忆功能，会记住当前网络中DHCP服务器的IP地址和上次分配给自己的IP地址。

因此，当PC重启后，通常不会按照上述的4个步骤按部就班的申请IP地址，而是通常会直接进入第三个阶段，直接向DHCP Server发送DHCP Request报文，请求自己上一次获得的IP地址。

如果DHCP Server同意，则会回应DHCP Reply报文，如果该IP地址已经被占用，或者其他情况造成DHCP Server不把该IP地址分配给DHCP Client，则DCHP Server会回应DHCP NACK报文，表示拒绝。这时，PC就必须重新进行DHCP四个阶段。





**==DHCP存在租约和续约机制==**，在默认情况下，当PC机申请到一个DHCP地址后，使用时间为一天，管理员也可以手动修改该时间，最短为1小时。

当PC申请的DHCP IP地址到达租约时间后，该IP地址就不可以继续使用，因此PC会在租约到期之前进行续约。



通常情况下，DHCP Client会进行两次续约，

第一次是在租约期的50%时候，DHCP Client会向DHCP Server发送DHCP Request报文，如果收到DHCP Server的回应，则续约成功。

第二次续约是在租约期的87.5%的时候，DHCP Client会再次向DHCP Server发送DHCP Request 报文，申请租约。



如果此时仍为收到DHCP响应的DCHP ACK报文，则就必须要重新进行DHCP的四个阶段，重新申请IP地址。





针对DHCP客户端的不同需求，不同的DHCP客户端使用的IP地址性质不同，有的DHCP客户端需要长期使用，有的DHCP客户端只是暂时借用。

DHCP服务器可以配置当前地址池中IP地址的**租用有效期限**，期满后DHCP服务器会收回该IP地址可继续分配给其它DHCP客户端使用。



如果用户希望针对某个DHCP客户端灵活配置地址租期，可以在DHCP客户端上配置期望地址租期：

当DHCP服务器分配地址租期时，会把DHCP客户端的期望地址租期和当前地址池中的地址租期比较，根据DHCP服务器自身分配规则提供合适的地址租期给DHCP客户端。



1. IP地址租约期限达到50%（T1）时，DHCP客户端会以单播的方式，向DHCP服务器发送DHCP REQUEST报文，请求更新IP地址租约。
   - 如果收到DHCP ACK报文，则租约更新成功；
   - 如果收到DHCP NAK报文，则重新发起申请过程。
2. IP地址租约期限达到87.5%（T2）时，如果仍未收到DHCP服务器的应答，DHCP客户端会向DHCP服务器发送更新其IP地址租约的广播报文。
   - 如果收到DHCP ACK报文，则租约更新成功；
   - 如果收到DHCP NAK报文，则重新发起申请过程。
3. 如果IP地址租约到期前都没有收到DHCP服务器的应答，DHCP客户端会停止使用此IP地址，重新发送DHCP DISCOVER报文请求新的IP地址。





## DHCP Snooping



目前[DHCP](https://info.support.huawei.com/info-finder/encyclopedia/zh/DHCP.html)协议（RFC2131）在应用的过程中遇到很多安全方面的问题，网络中存在一些针对DHCP的攻击，如DHCP Server仿冒者攻击、DHCP Server的拒绝服务攻击、仿冒DHCP报文攻击等。为了保证网络通信业务的安全性，引入DHCP Snooping技术。在DHCP Client和DHCP Server之间建立一道防火墙，以抵御网络中针对DHCP的各种攻击。





由于[DHCP](https://info.support.huawei.com/info-finder/encyclopedia/zh/DHCP.html) Server和DHCP Client之间没有认证机制，所以如果在网络上随意添加一台DHCP服务器，它就可以为客户端分配IP地址以及其他网络参数。

如果该DHCP服务器为用户分配错误的IP地址和其他网络参数，将会对网络造成非常大的危害。

https://info.support.huawei.com/info-finder/encyclopedia/zh/DHCP+Snooping.html





# DHCP服务配置

在实际工作中DHCP部署的位置肯定是在用户的网关上面，这里的网关指的就是VLAN网关，也就是核心交换机，核心设备通常支持的特性多，性能也属于网络中最好的一台设备，又充当内网的网关，所以它充当DHCP服务器，这样也是比较合理的。



**==地址池指的是DHCPv4服务器可以为客户端分配的所有IPv4地址的集合。除IPv4地址外，地址池内还可以配置租期、子网掩码、默认网关等网络参数。==**

**==在DHCPv4服务器为客户端分配IPv4地址时，这些网络参数也一并分配给客户端。==**





## **==接口DHCP地址池==**

接口地址池配置方式简单，只能用于用户与DHCP服务器在同一个网段的场景，并且只能给对应接口下的用户分配IP地址等网络参数；

适用于设备数量有限、配置以及维护量可控的小型网络。

在用户网关设备上配置基于接口地址池的DHCP服务器功能之后，对应接口下的固定主机、移动终端等都可以自动获取IP地址等网络参数。

```shell
# 核心交换机，全局启用DHCP功能
<HUAWEI> system-view
[HUAWEI] sysname Switch
[Switch] dhcp enable

# 创建业务VLAN
[Switch] vlan batch 10 to 11

# 1号口下联VLAN10
[Switch] interface gigabitethernet 0/0/1
[Switch-GigabitEthernet0/0/1] port link-type access
[Switch-GigabitEthernet0/0/1] port default vlan 10
[Switch-GigabitEthernet0/0/1] quit

# 2号口下联VLAN20
[Switch] interface gigabitethernet 0/0/2
[Switch-GigabitEthernet0/0/2] port link-type access
[Switch-GigabitEthernet0/0/2] port default vlan 20
[Switch-GigabitEthernet0/0/2] quit

# VLAN10网段
[Switch] interface vlanif 10
[Switch-Vlanif10] ip address 10.10.10.254 24    # 接口地址所属的IP地址网段即为接口地址池。10.10.10.1~10.10.10.254
[Switch-Vlanif10] dhcp select interface   		# 使能接口采用接口地址池的DHCP服务器功能，缺省未使能
[Switch-Vlanif10] dhcp server lease day 30  	# 租期的缺省值为1天，修改租期为30天
[Switch-Vlanif10] dhcp server excluded-ip-address 10.10.10.100 10.10.10.200 			    #  不参与自动分配的IP地址    
[Switch-Vlanif10] dhcp server static-bind ip-address 10.1.1.100 mac-address 00e0-fc12-3456  # 为Client_1分配固定的IP地址
dhcp server excluded-ip-address start-ip-address [ end-ip-address ]
[Switch-Vlanif10] quit

#  VLAN20网段
[Switch] interface vlanif 11
[Switch-Vlanif20] ip address 10.1.2.1 24  		# 接口地址所属的IP地址网段即为接口地址池。
[Switch-Vlanif20] dhcp select interface  	    # 使能接口采用接口地址池的DHCP服务器功能，缺省未使能
[Switch-Vlanif20] quit


# 关键就在于这个命令，当启用DHCP接口模式后，它会以这个VLANIF接口下配置的地址充当网关、掩码作为下发给客户端的掩码信息。
```





## **==全局DHCP地址池==**



**基于全局方式的地址池是在系统视图下创建的指定网段的地址池。全局地址池中的地址可以分配给==设备所有接口==下的客户端。**

==**当DHCPv4服务器与客户端不在同一个网段时，需要部署DHCPv4中继。**==





全局地址池可应用于大型网络，推荐

- 在核心层设备上配置基于全局地址池的DHCP服务器功能
- 在服务器区域搭建一台专门的DHCP服务器统一分配IP地址等网络参数。而用户网关设备上只需要启用简单的DHCP中继功能即可。



全局地址池由一个或多个IPv4地址段组成，各个地址段内的IPv4地址不能有重叠。

**section**（IP地址池视图）命令设置的地址段范围必须在**network**（IP地址池视图）命令设置的地址范围之内。



```bash
[Core-Switch] ip pool vlan10
[Core-Switch-ip-pool-vlan10] network 10.10.10.0 mask 255.255.255.0  		# 定义网段
[Core-Switch-ip-pool-vlan10] gateway-list 10.10.10.1                		# 定义网关
[Core-Switch-ip-pool-vlan10] dns-list 114.114.114.114 8.8.8.8       		# 定义DNS
[Core-Switch-ip-pool-vlan10] lease day 1                            		# 租期（可选）
[Core-Switch-ip-pool-vlan10] excluded-ip-address 10.10.10.2 10.10.10.10 	# 排除预留IP（可选）


```



DHCPv4服务器依据是否部署DHCPv4中继来选择地址池。

无DHCPv4中继场景下，DHCPv4服务器选择与接收DHCPv4请求报文的接口IPv4地址处于同一网段的地址池。有DHCPv4中继场景下，DHCPv4服务器选择与DHCPv4请求报文中giaddr字段（标识客户端所在网段）位于同一网段的地址池。

用户需要根据客户端的数量和接入断开的时间、频率来确定地址池内需要部署的IPv4地址数量。



# 如何防止私接小路由器

在企业网络管理中，“私接的路由器”就是这样一个“蚁穴”，从宏观来看它只是个家用级的小路由器，但带来的危害却极大。

公司内总有个别员工为了自己方便，可能会私自从网络端口上连接一个家用无线路由器，但这会立刻引入一系列安全和稳定性的风险，比如：

- **==DHCP冲突==：私接路由器通常默认开启DHCP服务，会向网络中分发错误的IP地址，导致其他合法用户无法正常上网或访问内部资源。**
- **==安全后门==：家用路由器往往存在固件漏洞、弱密码等问题，一旦被攻击者利用，就成为了绕过企业防火墙和安全策略，直接进入内网的跳板。**
- **==网络风暴与性能下降==：不当的配置可能引发广播风暴，或形成网络环路，严重影响整个网段的性能。**
- **==管理黑洞==：这些设备游离于IT部门的管理之外，无法被监控、审计和统一策略管理。**



## **一、蛛丝马迹 —— 发现私接路由器的“症状”**

**1. 被动发现（用户报障）**

这是最常见的发现方式。通常会收到以下类型的用户反馈或者投诉：

- “我的电脑获取到了一个奇怪的IP地址（例如 192.168.1.x 或 192.168.0.x），上不了外网了。”
- “网络时断时续，非常不稳定。”
- “我的电脑提示IP地址冲突。”
- “连接Wi-Fi后，无法访问公司的业务服务器。”

当接到这类报障时，第一个就要怀疑是否存在非法的DHCP服务器，而私接小路由器是最大的嫌疑人。



**2. 主动发现（技术巡检）**

作为专业的网工，我们不能总等着问题上门，主动巡检是必要的。

- **检查DHCP服务器日志：定期检查企业官方DHCP服务器的日志。如果发现大量 DHCPDECLINE 或 DHCPNAK 的记录，这表明网络中可能存在其他DHCP服务器在“抢生意”。**
- **利用网络管理系统（NMS）：像Zabbix、SolarWinds、华为eSight等网管平台，可以监控交换机端口的MAC地址学习情况。如果发现某个端口下短时间内学习到大量MAC地址，或者设备的CDP/LLDP信息显示为一个未知或家用品牌（如TP-Link, D-Link, Tenda等），就需要高度警惕。**
- **启用交换机的安全特性日志：在交换机上配置DHCP Snooping功能，它可以记录所有非法的DHCP Offer报文，并直接报告其来源MAC地址和端口。这是最精准、最高效的主动发现手段。**



## **二、顺藤摸瓜 —— 定位私接路由器的物理位置**

一旦确认存在私接路由器，下一步就是精准定位它的物理位置。这里的核心思路是：

**从受影响的用户出发，找到非法DHCP服务器的MAC地址，再通过MAC地址在交换机网络中逐级追查，最终锁定其连接的物理端口(下面以华为设备为例)：**



**第1步：获取关键信息**

在受影响的用户电脑上，打开命令提示符（CMD），执行 **ipconfig /all**。 记录下三个关键信息：

- **用户自己的MAC地址 (Physical Address)**
- **错误的IPv4地址**
- **错误的默认网关 (Default Gateway) 和 DHCP服务器地址(通常这两个IP是同一个，即私接路由器的LAN口地址)**

**示例：**用户获取到IP **192.168.0.31**，网关是 **192.168.0.1**。这个 **192.168.0.1** 就是我们要找的目标。（备注：如果电脑有多个网卡，一定要找确定出现问题所对应的具体网卡）



**第2步：获取私接路由器的MAC地址**

在同一台受影响的电脑上，**ping** 一下刚刚记录的错误网关地址，以确保本地ARP缓存表中有它的记录。

```
ping 192.168.1.1
```

然后，查看本地ARP缓存表，找到该IP对应的MAC地址。



```
arp -a
```

在输出结果中找到 192.168.1.1 对应的物理地址，例如 ==**30-0d-9e-xx-xx-xx**。**这个MAC地址就是私接路由器的MAC地址，是我们追踪的核心线索。**==



**第3步：在交换机网络中追踪MAC地址**

现在，我们需要从核心交换机开始，一步步往下查。

**1、登录核心交换机：**display mac-address **300d-9exx-xxxx**，这个命令的输出会告诉你，要去往这个MAC地址，流量应该从哪个端口出去。这个端口通常是连接到下一级汇聚或接入交换机的。

**2、逐级跳转：** 根据上一步查到的端口信息，登录到下一台交换机，重复执行相同的MAC地址查询命令。例如，在核心上查到*MAC* **300d-9exx-xxxx**位于 *TenGigabitEthernet1/1/1* 端口，而这个端口连接的是一台名为 *Access-Switch-Floor5* 的接入交换机。那么我们下一步就登录到 *Access-Switch-Floor5*。

**3、锁定最终的接入端口：** 在接入层交换机上再次执行查询命令。这次，输出结果中的端口应该不再是连接另一台交换机的Trunk口，而是一个Access口，例如 GigabitEthernet1/0/10。

**至此，我们已经成功定位到私接路由器连接到了这台交换机的 G1/0/10 端口上。**



**第4步：物理定位**

- 查看交换机端口的描述信息 (show interface G1/0/10 description)，通常这里会记录端口对应的房间号或工位号。
- 如果没有描述，可以查询公司的网络布线图纸。
- 如果以上都没有，最直接的方法就是带着笔记本电脑和网线去交换机所在的弱电井，将 G1/0/10 端口的网线拔下，接到你的电脑上，确认网络环境。然后通知行政或相关部门，一起去现场根据工位找到对应的网口。



## **三、手起刀落 —— 处理与根治**

**1. 立即处理 (治标)**

**禁用端口：** 在定位到的交换机端口上，立即执行 shutdown 命令。这会立刻切断私接路由器的连接，恢复受影响网段的正常秩序。

**现场移除：** 与相关部门（如行政、人事）沟通，前往现场向该员工解释公司网络安全政策，并移除该私接设备。

**2. 长期根治 (治本)**

为了从根本上杜绝此类问题，必须在技术和管理上双管齐下。



**方法一：部署DHCP Snooping（**这是防御非法DHCP服务器最有效的技术手段**）**

**原理：** 交换机将端口分为“信任”和“不信任”两类。只允许来自“信任”端口（连接合法DHCP服务器的端口和交换机级联口）的DHCP Offer/Ack报文通过，所有来自“不信任”端口（连接终端用户的端口）的此类报文都会被直接丢弃。



**方法二：启用端口安全 (Port Security)：**

***\*原理：通过绑定MAC地址实现接入控制，防止未授权设备接入。(限制一个交换机端口下可以学习到的MAC地址数量，私接路由器下会连接多个设备（手机、笔记本等），其端口下的MAC地址数量会超过1)。\****



**3、实施网络准入控制 (NAC)：**

这是最严格、最安全的方案，所有接入网络的设备都必须经过身份认证（如**802.1X**），未经认证的设备都无法访问网络，这是大型企业或对安全要求高的环境的最佳实践。



**4、加强管理与宣贯：**

- 制定明确的IT策略，明令禁止连接任何未经授权的网络设备。
- 通过邮件、内部培训等方式，向员工普及私接路由器的危害性，让他们理解这不是“为了方便”的小事，而是关系到整个公司信息安全的大事。





# DHCP配置

动态主机配置协议DHCP（Dynamic Host Configuration Protocol）采用客户端/服务器模式对用户的网络参数进行动态配置和集中管理。

其中，DHCP服务器通过地址池为用户分配IP地址等网络参数。地址池分为**==接口地址池==**和**==全局地址池==**两种。



在用户网关设备上配置基于接口地址池的DHCP服务器功能之后，对应接口下的固定主机、移动终端等都可以自动获取IP地址等网络参数，不需要用户手动配置修改。



# DHCP 服务

一个由 [Internet Systems Consortium](https://www.isc.org/)(ISC)开发的开源DHCPv4/DHCPv6服务器。

Kea是一个高性能的，可扩展的DHCP服务器引擎。通过[hooks library](https://kea.readthedocs.io/en/latest/arm/hooks.html)可以很容易的修改和扩展。

```bash
# install the build environment
sudo apt -y install automake libtool pkg-config build-essential ccache meson ninja-build libboost-all-dev liblog4cplus-dev
	
# install the dependencies
sudo apt -y install libboost-dev libboost-system-dev liblog4cplus-dev libssl-dev


# download package
wget https://downloads.isc.org/isc/kea/3.0.0/kea-3.0.0.tar.xz

```





