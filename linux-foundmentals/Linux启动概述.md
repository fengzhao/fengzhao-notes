# 混沌初开

本文分析从按下电源键到加载BIOS以及后续bootloader的整个过程。

犹如盘古开天辟地一般，该过程将混沌的操作系统世界分为清晰的内核态和用户态，并经历从实模式到保护模式的变化。





在个人电脑上，**引导装载程序**使用**基本输入输出系统（以下简称BIOS）**或者 **统一可扩展固件接口（Unified Extensible Firmware Interface，以下简称UEFI）**来访问磁盘。

几乎所有的磁盘设备都有固件系统供BIOS通过线性块寻址（Linear Block Addressing）来访问硬件。

虽然性能不怎么样，但是这种方式可以访问磁盘的任意位置。

引导装载程序往往是唯一使用BIOS访问磁盘的程序。内核使用的是它自己的高性能驱动程序。

大多数现在的引导装载程序都能够读取分区表，内建以只读模式访问文件系统的功能，因此它们能够查找和读取文件。这使得动态配置和完善引导装载程序变得非常简单。

并不是所有的Linux引导装载程序都有这些功能，配置引导装载程序因而变得困难得多。



以BIOS为核心的固件产业，是信创产业链的重要组成部分，可被誉为信创产业的“山海关”。

在计算机体系中，BIOS 有着比操作系统更为底层和基础性的作用，是机器点亮后第一个被激活的系统程序，主要负责检测、访问与调试底层硬件资源，并分配给操作系统，以保障整个机器顺利安全运转。

 

目前，全球 X86 授权 BIOS 厂商共计 4家，它们分别是 AMI、Phoenix、Insyde 和百敖，而百敖（卓易信息旗下）又是境内唯一一家 BIOS 厂商。



**BIOS（Basic Input Output System）**，即基础输入输出系统，是刻在主板 ROM 芯片上不可篡改的启动程序，BIOS 负责计算系统自检程序（POST，Power On Self Test）和系统自启动程序，因此是计算机系统启动后的第一道程式。

由于不可篡改性，故程序存储在 ROM 芯片中，并且在断电后，依然可以维持原有设置。

BIOS 主要功能是控制计算机启动后的基本程式，包括硬盘驱动（如装机过程中优先选择 DVD 或者 USB 启动盘），键盘设置，软盘驱动，内存和相关设备。



**BMC（Baseboard Management Controller）与IPMI（Intelligent Platform Management Interface）**

即基板管理控制器与智能型平台管理接口，是服务器的基本核心功能子系统，负责服务器的硬件状态管理、操作系统管理、健康状态管理、功耗管理等核心功能。

**BMC 是独立于服务器系统之外的小型操作系统，**是一个集成在主板上的芯片，也有产品是通过 PCIE 等形式插在主板上，对外表现形式只是一个标准的 RJ45 网口，拥有独立 IP 的固件系统。

服务器集群一般使用 BMC 指令进行大规模无人值守操作，包括服务器的远程管理、监控、安装、重启等。



**IPMI 是一组交互标准管理规范**，由 Intel、HP、Dell 和 NEC 公司于1998年9月16日共同提出，主要用于服务器系统集群自治，监视服务器的物理健康特征，如温度、电压、风扇工作状态、电源状态等。

同时，IPMI 还负责记录各种硬件的信息和日志记录，用于提示用户和后续问题的定位。目前，IPMI 已经为超过 200 多家计算机供应商所支持。

**IPMI 是独立于主机系统 CPU、BIOS/UEFI 和 OS 之外，可独立运行的板上部件，其核心部件即为 BMC。**

或者说，BMC 与其他组件如 BIOS/UEFI、CPU 等交互，都是经由 IPMI 来完成。在 IPMI 协助下，用户可以远程对关闭的服务器进行启动、重装、挂载 ISO 镜像等。



**EFI（Extensible Firmware Interface），是可扩展固件接口。**

由于传统的 BIOS 是基于 16 位处理器开发的汇编程序，在面对 32/64 处理器时，效率低下的短板即暴露出来，因此， Intel 推出的一种计算系统中 BIOS 新的替代升级方案。



**UEFI（Unified Extensible Firmware Interface），统一可扩展固件接口**，是 EFI 的规范化版本，也是BIOS的进化版。

为便于将UEFI BIOS与传统BIOS区分，传统BIOS又被称为Legacy BIOS 。2005年，Intel 将 EFI 交由 UEFI Forum 来推广与发展，EFI 更名 UEFI。

UEFI 负责加电自检（POST）、联系操作系统以及提供连接操作系统与硬件的接口。**现有主流 BIOS 固件公司已基本采用 UEFI。**

从主要功能上来说，UEFI BIOS 和 Legacy BIOS 都是为了初始化硬件平台并引导操作系统。两者主要差异在于 Legacy BIOS 无统一标准，而 UEFI BIOS 统一定义了固件和操作系统之间的接口标准。

1、UEFI BIOS 主要以 C 语言编写，易于实现跨架构跨平台支持并共享代码模块，而 Legacy BIOS 通过则是汇编语言编写

2、UEFI BIOS 完整支持新固件安全功能，从最大程度上降低固件被攻击的风险

3、Legacy BIOS 移植性差，重复开发现象严重。整体而言，UEFI BIOS 较 Legacy BIOS 的优势明显



UEFI安全引导（Secure Boot）的核心职能就是利用数字签名来确认EFI驱动程序或者应用程序是否是受信任的。

Secure Boot只是UEFI的一个部分。两者的关系是局部与整体的关系。Secure Boot的目的，是防止恶意软件侵入。它的做法就是采用密钥。UEFI规定，主板出厂的时候，可以内置一些可靠的公钥。

任何想要在这块主板上加载的操作系统或者硬件驱动程序，都必须通过这些公钥的认证。也就是说，这些软件必须用对应的私钥签署过，否则主板拒绝加载。由于恶意软件不可能通过认证，因此就没有办法感染Boot。

这个设想是好的。但是，UEFI没规定哪些公钥是可靠的，也没规定谁负责颁发这些公钥，都留给硬件厂商自己决定。现在微软就是要求，主板厂商内置Windows 8的公钥。

微软规定，所有预装Windows 8的厂商（即OEM厂商）都必须打开Secure Boot。

因此，消费者购买一台预装Windows 8的台式机或笔记本，想要在上面再安装其他操作系统（包括以前版本的Windows）是不可能的，除非关闭Secure Boot，或者其他操作系统能够通过Windows 8/8.1公钥的认证。

Secure Boot规格的本意是，让操作系统厂商自行选择公钥，通过认证。但是实际上，只有微软公司才有能力，让主板厂商内置它的公钥，其他公司都不具备这种能力。

根据微软针对OEM厂商的一则规定，Windows 8要求PC电脑采用UEFI（统一可扩展固件接口），这个接口将会替代PC机诞生以来历史悠久的BIOS固件设置。

关于UEFI这个标准接口，是支持 Windows、Linux 和 OS X 操作系统的，只是微软要求预装Windows 8 的PC电脑需要支持安全性启动机制，启动过程中涉及到的软件/固件都必须打上CA数字签名，这样，对于Linux 这种开源的无签名的系统就会直接阻止。

因此，如果要在打开Secure Boot的主板上安装Linux系统，这个系统就必须通过Windows 8的认证。



EFI分区（也称为EFI系统分区或ESP）是一种特殊的分区，通常用于存储引导加载程序和其他与引导相关的文件。它是为了支持基于UEFI（统一固件接口）的系统而设计的。

- **引导启动**：EFI分区中存储着操作系统的引导加载程序（如GRUB、Windows Boot Manager等）和相关的配置文件。当系统启动时，UEFI固件会从EFI分区中的引导加载程序启动操作系统。因此，EFI分区是系统引导的关键部分。

- **兼容性和互操作性**：UEFI的引入旨在取代传统的BIOS固件。与BIOS相比，UEFI提供了更先进、更灵活的启动方式，并支持更大容量的硬盘驱动器。EFI分区的设计允许UEFI固件识别和访问其中的引导文件，以确保与UEFI兼容的操作系统能够正确地加载和启动。

- **文件系统支持**：EFI分区通常使用FAT32文件系统格式化。这是因为FAT32是一种广泛支持和被UEFI固件识别的文件系统。通过使用FAT32文件系统，EFI分区可以在不同的操作系统之间进行交互，并且可以很方便地在EFI环境下读取和写入文件。

- **固件更新**：EFI分区还可以用于存储和管理UEFI固件的更新。固件更新通常以固件更新软件包（如UEFI固件更新工具）的形式提供，这些软件包会被放置在EFI分区中，并由UEFI固件在启动时进行检测和应用。

- **安全启动**：EFI分区在安全启动（Secure Boot）中起到关键的作用。安全启动是通过验证引导加载程序和操作系统的数字签名来确保系统启动过程的安全性。EFI分区存储了用于验证引导加载程序和操作系统签名的证书和密钥，以及相关的安全策略。

- **多操作系统支持**：EFI分区可以存储多个操作系统的引导加载程序和配置文件，从而使得在同一台计算机上安装和管理多个操作系统变得更加容易。通过在EFI分区中设置不同的引导选项，用户可以选择启动哪个操作系统。

- **引导修复和故障排除**：EFI分区也提供了引导修复和故障排除的功能。如果操作系统引导失败或发生其他问题，用户可以借助EFI分区中的工具和文件进行修复和恢复。

- **固件配置和设置**：EFI分区还可以存储固件相关的配置和设置文件。这些文件可以包含用于配置UEFI固件设置的数据，例如启动顺序、硬件选项和设备设置等。

- **引导参数和选项**：EFI分区可以存储操作系统引导时所需的参数和选项。这些参数和选项可以用于配置操作系统的启动行为，例如设置内核参数、指定启动模式或加载特定的驱动程序。

- **固件诊断和日志记录**：EFI分区可以用于存储固件的诊断工具和日志记录文件。这些工具和文件可以帮助用户分析和解决固件相关的问题，包括硬件故障、兼容性问题等。

- **固件恢复和备份**：EFI分区可以用作固件恢复和备份的存储介质。在某些情况下，如果UEFI固件损坏或需要回滚到之前的版本，用户可以使用EFI分区中的备份文件来恢复固件。

- **第三方工具和插件**：EFI分区还允许第三方开发人员存储和加载自定义的工具和插件。这些工具和插件可以扩展和增强系统的功能，例如优化性能、添加额外的安全特性，或提供其他附加功能。

- **系统恢复和备份**：EFI分区可以用作系统恢复和备份的存储介质。用户可以在EFI分区中保存系统备份或恢复镜像，以方便在需要时进行系统还原或迁移。

- **驱动程序管理**：EFI分区可以存储硬件设备的驱动程序，以便在系统启动时加载所需的驱动程序。这样可以简化操作系统的安装过程，尤其是对于一些特殊的硬件设备，如RAID卡、网卡等。

- **用户自定义设置**：EFI分区也可以用于存储用户自定义的设置和配置文件，如启动菜单的个性化配置、预设的启动选项等。这样可以实现个性化的启动体验和定制化的系统设置。

- **物理安全性**：EFI分区可以用于存储设备的物理安全信息，如设备的唯一标识符（UUID）、序列号等。这些信息可以用于设备的身份验证和安全审计。

- **安全启动**：EFI分区可以用于存储安全启动（Secure Boot）相关的证书和密钥。安全启动是一种保护系统免受恶意软件和未经授权的操作系统启动的技术，通过验证引导加载程序和操作系统的数字签名来确保系统的完整性和安全性。

- **固件设置配置**：EFI分区可以存储固件设置的配置文件。这些配置文件包含了系统启动时的默认参数和选项，如启动模式、启动顺序、设备的识别方式等。用户可以在EFI分区中修改和定制这些配置文件来满足自己的需求。

- **固件调试**：EFI分区可以存储固件调试相关的信息和工具。这些信息和工具可以帮助开发人员进行固件调试和故障排除，以解决固件层面的问题。

- **固件扩展**：EFI分区允许第三方开发者扩展和增强固件的功能。他们可以在EFI分区中存储自己开发的固件扩展程序（EFI Shell、插件等）或驱动程序，以实现特定的功能需求或硬件兼容性。





**在整个计算机体系中，CPU 处于核心关键环节。**根据指令集不同，又可分为 X86（CISC，复杂指令集）和 非 X86 架构（RISC，精简指令集）。

前者主要厂商包括 Intel/AMD/海光/兆芯；后者包括鲲鹏（ARM）、飞腾（ARM）、龙芯（MIPS）和申威（Alpha）。

在 BIOS/BMC 产业链中，CPU 处于产业上游，且上游 CPU 厂商系统核心代码授权与 BIOS/BMC 经营密切相关，固件厂商只有在获得 CPU 相关核心参数后，才有资质开发基于其版本的 BIOS/BMC 程序。 

当前，全球 X86 计算设备中，PC、服务器等采用的芯片主要是 Intel 的 X86 架构芯片。

因此，Intel 授权代码是 BIOS/BMC 工作开展的前提，全球目前只有四家公司与英特尔签订合作协议，用于独立开发商业化用途的 X86 架构 BIOS，它们分别是美国的 AMI、Phoenix、中国台湾 Insyde，以及卓易信息全资子公司南京百敖。 

**固件业务下游主要是计算设备厂商。**下游整机厂商出货量多少直接决定固件 BIOS/BMC 厂商需求量，当前国内市场主流整机厂商包括浪潮、华为、联想、新华三、中科曙光、中国长城。







# **主板固件UEFI/BIOS**

> 固件（Firmware）是固化在特定芯片里的软件程序，是硬件设备最底层的软件。

可以把 UEFI 和 BIOS 都理解成一种固件，其主要功能是为计算机提供最底层的、最直接的硬件设置和控制（包括启动操作系统），而 UEFI 是传统 BIOS 升级替代品，功能更强，并兼容传统 BIOS。

## BIOS

由于计算机启动是一个很矛盾的过程，即必须先运行程序，然后计算机才能启动，但是计算机不启动就无法运行程序！

因此，需要想办法把一小段程序装进内存，然后计算机才能正常运行，这段程序称为 BIOS（基本输入输出系统），保存在计算机主板上的一个芯片里（称为BIOS ROM）

通常 BIOS 会被认为是随着 IBM PC 的出现而产生的，实际上 BIOS 要早于 IBM PC，早在1975年，BIOS 的概念就在 CP/M 系统上出现。

后来随着计算机硬件的发展，除了上面提到的主板 BIOS（也叫系统 BIOS）以外，其他硬件也有了 BIOS 程序，如显卡 BIOS，硬盘 BIOS 等，但我们一般提到的 BIOS 固件专门指主板 ROM 芯片里的 BIOS 程序（即系统 BIOS）

### **BIOS功能**

- 检测硬件，又叫 POST 自检，就是检测硬件是否还正常的工作；

- 初始化硬件，设置其基本状态，使得整个计算机达到所谓的＂可用状态＂（Ready State）；

- 启动 OS Loader 加载操作系统；

  BIOS 固定地加载存储器最前面扇区（LBA0）里的引导程序（即 BootLoader），然后，由 BootLoader 启动操作系统。

- 在操作系统启动起来以后，一部分继续驻留内存，向操作系统以及其他软件提供基本的系统级的服务，如磁盘读写（INT13 中断服务）等；

- 修复硬件缺陷，如 Intel CPU 的 SMM 功能。

### **BIOS启动过程**

- 通电：CPU 初始化，并执行 BIOS 程序；

- 自检：BIOS 程序启动开始 POST 自检，进行更完整的硬件（检查 CPU、RAM、键盘、鼠标等）检测；

  此阶段无法屏幕显示，只能通过主板扬声器报警。

- 其他初始化：初始化显卡和其他设备并显示到屏幕；

- 加载 MBR：BIOS 提供中断服务，读取 CMOS 设置，读取第一个启动磁盘的 MBR 到内存让 CPU 执行（此后 BIOS 就撒手不管了），然后由 MBR 引导代码启动操作系统。

### **BIOS 的缺点**

BIOS 的缺点：

- 不支持2.2TB硬盘作为启动盘
- 安全与扩展性差等

## **UEFI**

由于BIOS各种缺点，英特尔公司从 2000 年开始，发明了可扩展固件接口(Extensible Firmware Interface)，用以规范 BIOS 的开发。而支持 EFI 规范的 BIOS 也被称为EFI BIOS。

之后为了推广EFI，业界多家著名公司共同成立了统一可扩展固件接口论坛(UEFI Forum)，英特尔公司将 EFI 1.1 规范贡献给业界，用以制订新的国际标准 UEFI 规范。

UEFI 是一种规范，不同厂商根据该规范对 UEFI 的实现并烧录到芯片里，该实现程序就称为 UEFI 固件。

### **UEFI 启动过程**

EFI 启动过程如下：

- SEC（安全性）阶段：通电，内存未初始化，CPU 只能使用 Cache 来验证 CPU、芯片组和主机驱动；
- PEI（EFI前初始化）阶段：初始化一小部分低地址内存空间，CPU 开始使用此内存初始化CPU、芯片组 和主板，随后EFI驱动载入内存；
- DXE（驱动执行环境）阶段：此阶段内存、CPU（指CPU插槽上的物理CPU,非CPU核心）、PCI、USB、 SATA 和 Shell 都会被初始化；
- BDS（开机设备选择）阶段：此阶段用户可选择从检测到启动设备中选择启动设备；
- TSL（临时系统载入）阶段：此阶段将由启动设备上的系统接手正式进入操作系统， 若 BDS 阶段选择 UEFI Shell则会进入 UEFI 的简单命令行界面，可在此界面做简单维护和诊断。

### **启用 UEFI 的条件**

- 电脑主板支持 UEFI；

  2010年后的主板基本都支持。

- 操作系统支持 UEFI；

  64位Windows基本都支持

- 磁盘具有 GUID 分区表（GPT）。

- 磁盘分区表中必须有 FAT 分区。

  特殊标志的 FAT 分区（即 ESP 分区，也叫 EFI 系统分区），该分区要作为第一个磁盘分区（进入系统会自动隐藏）。

- 可启动的 efi 文件，一般为 `\\EFI\\BOOT\\BOOTx64.EFI`

  注，不同平台文件名可能不同。

从上面的启用条件发现，虽然要求支持 UEFI 的固件必须支持读取 GPT 磁盘类型中的 FAT(12/16/32) 文件系统格式，并可读取该 FAT 中的文件和执行 `*.efi` 的可执行文件。

但是 UEFI 规范并没有提到固件不能识别其他文件系统类型（如苹果 Mac 的 HFS+）并从中加载启动装载程序(苹果 Mac 在这方面有与众不同的个性)。

# **操作系统的引导过程**

传统 BIOS 与 UEFI 主板引导操作系统过程如下：

- BIOS：设备加电 -> BIOS 初始化/自检 -> boot loader 引导（扇区代码） -> OS 操作系统；
- UEFI：设备加电 -> UEFI 平台 -> efi 应用（硬盘文件） -> OS 操作系统。

### **引导装载程序（boot loader）**

引导装载程序（boot loader）是计算机开机自检完成后装载操作系统或者其他系统软件的计算机程序。自检完成后运行引导装载程序，然后再加载并运行软件，引导装载程序可以从硬盘装载到主内存中。

在 MBR 磁盘分区中，引导程序位于主引导记录（MBR）。

但是随着计算机操作系统越来越复杂，位于主引导记录的空间已经放不下引导操作系统的代码，于是就有了第二阶段的引导程序，而 MBR 中代码的功能也从直接引导操作系统变为了引导第二阶段的引导程序。

因此引导程序通常分为两部分：**第一阶段引导程序位于主引导记录**，用以引导位于某个分区上的第二阶段引导程序，如：NTLDR、BOOTMGR 和 GNU GRUB 等。

> 对于 UEFI 系统，由 EFI 应用程序（即 EFI 系统分区中的 *.efi 文件）取代了 MBR 和第二阶段引导程序，UEFI 固件会加载引导程序的 *.efi 文件，再由引导程序加载操作系统。

<aside> 💡 **注意，理论上传统 BIOS 仅支持 MBR 硬盘启动，在操作系统支持下，GPT 类型的磁盘仅可做数据盘。**

</aside>

### **bootloader 引导 Windows**

微软的 boot loader 做法是加载分区表（DPT）中标记为活动标志的分区引导记录（PBR），PBR 里的引导代码加载操作系统的引导文件到内存运行。

例如，Windows 的 bootmgr，Windows 的 PBR 可以识别 FAT32 和 NTFS 两种分区，找到分区根目录的 bootmgr 文件，并加载、执行 bootmgr。

bootmgr 没有 MBR 和 PBR 的大小限制，可以做更多的事，它会加载并分析BCD启动项存储，而且 bootmgr 可以跨越磁盘读取文件。所以无论我们有几个磁盘，在多少块磁盘上装了 Windows，一个电脑只需要一个 bootmgr 就行了。

bootmgr 会去加载某磁盘某 NTFS 分区的 `\\Windows\\System32\\WinLoad.exe`，然后，由 WinLoad.exe 启动 Windows