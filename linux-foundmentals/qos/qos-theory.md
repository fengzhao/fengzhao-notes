# 流量控制

流量控制是指在路由器上接收和传输数据包的队列系统和机制的统称。包括决定(如果和)输入接口上以哪种速率接收哪个包，以及决定在输出接口上以哪种顺序传输那些包。

在最简单的模型中，流量控制包含简单的队列，该队列收集了所有的报文，并在硬件(或底层设备)可以接收报文时尽快让这些报文出队列。这种队列即FIFO。它就像一个进入高速公路的收费站，每辆车必须停下并缴纳过路费，而此时其他汽车也必须等待。

> 注：Linux下默认的qdisc为[`pfifo_fast`](https://tldp.org/HOWTO/Traffic-Control-HOWTO/classless-qdiscs.html#qs-pfifo_fast)，它比[FIFO](https://tldp.org/HOWTO/Traffic-Control-HOWTO/classless-qdiscs.html#qs-fifo)更加复杂。



在各种软件中都有队列的影子。队列是一种组织挂起的任务或数据的方式。由于网络链接通常会以序列化的方式携带数据，因此需要一个队列来管理出站的数据包。



在台式机和一台高效的网络服务器共享(到因特网的)同一上行链路的情况下，可能会对带宽资源产生竞争。

例如，服务器填充路由器上的输出队列的速度可能比通过链路传输数据的速度还要快，此时路由器开始丢包(缓冲已经满了)，这样台式机(可能是交互应用的用户)可能会面临丢包和高延迟。

通过划分内部队列来服务这两种不同的应用，就可以在两个应用间更好地共享网络。

**流量控制是一组允许管理员对这些队列进行精细控制的工具和网络设备的排队机制的统称。虽然这些工具重新分配流量和包的能力是强大的，同时也可能会很复杂，但最好留有足够的带宽。**





**流量监管**和**流量整形**通过监督进入网络的流量速率，用来限制流量及其资源的使用，保证更好的为用户提供服务。

如果报文的发送速率大于接收速率，或者下游设备的接口速率小于上游设备的接口速率，就会引起网络拥塞。如果不限制用户发送的业务流量，大量用户不断突发的业务数据会使网络更加拥挤。

为了使有限的网络资源能够更好地发挥效用，更好地为更多的用户服务，必须对用户的业务流量加以限制。



流量监管和流量整形就是一种通过对流量规格的监督，来限制流量及其资源使用的流控策略。





# Linux下的QOS：理论篇

关于qos ，也是linux下面必备功能之一，一般只需要结合 iptables/etables/iproute2 和 tc 配合即可实现大部分功能。

网上讲这么方面的资料很多，大部分都讲 tc 命令的应用。这里就先从理论入手。



在Linux中进行网络资源的优先级管理主要涉及到流量控制（Traffic Control，简称TC）和服务质量（Quality of Service，简称QoS）。



QoS（Quality of Service）服务质量，是网络的一种安全机制, 是用来解决网络延迟和阻塞等问题的一种技术。

但是对关键应用和多媒体应用就十分必要。当网络过载或拥塞时，QoS 能确保重要业务量不受延迟或丢弃，同时保证网络的高效运行。



在网络总带宽固定的情况下，如果某类业务占用的带宽越多，那么其他业务能使用的带宽就越少，可能会影响其他业务的使用。

因此，网络管理者需要根据各种业务的特点来对网络资源进行合理的规划和分配，从而使网络资源得到高效利用。例如，语音、视频和重要的数据应用在网络设备中可以通过配置QoS优先得到服务。



### QoS服务模型

通常QoS提供以下三种服务模型：

- Best-Effort service（尽力而为服务模型）（系统默认；PFIFO_FAST）
- Integrated service（综合服务模型，简称Int-Serv）
- Differentiated service（区分服务模型，简称Diff-Serv）



##### (1) Best-Effort服务模型

Best-Effort是一个单一的服务模型，也是最简单的服务模型。对 Best-Effort 服务模型，网络尽最大的可能性来发送报文。但对时延、可靠性等性能不提供任何保证。

Best-Effort 服务模型是网络的缺省服务模型，通过 FIFO 队列来实现。它适用于绝大多数网络应用，如 FTP、E-Mail 等。

##### (2) Int-Serv服务模型

Int-Serv 是一个综合服务模型，它可以满足多种 QoS需求。该模型使用资源预留协议（RSVP），RSVP 运行在从源端到目的端的每个设备上，可以监视每个流，以防止其消耗资源过多。

这种体系能够明确区分并保证每一个业务流的服务质量，为网络提供最细粒度化的服务质量区分。

但是，Inter-Serv模型对设备的要求很高，当网络中的数据流数量很大时，设备的存储和处理能力会遇到很大的压力。

Inter-Serv模型可扩展性很差，难以在 Internet 核心网络实施，前主要与 MPLS TE（Traffic Engineering，流量工程）结合使用.

##### (3) Diff-Serv服务模型

Diff-Serv是一个多服务模型，它可以满足不同的QoS需求。与Int-Serv不同，它不需要通知网络为每个业务预留资源。

区分服务实现简单，扩展性较好， 可以说是为现在的网络量身打做的。这个这种类型的QOS中，数据流是要进行分类的，然后，我们可以进一步的对各种不同类的流进行的控制。

这个控制的实现就是通过策略表来实现的。这样简单一说，我们就该知道了，实现他们是要有个类表，然后还得有个控制表—策略表.

它由 RFC2475 定义，在区分服务中，根据服务要求对不同业务的数据进行分类，对报文按类进行优先级标记，然后有差别地提供服务。







## QoS的度量指标

影响网络质量的因素包括传输链路的带宽、报文传送时延和抖动、以及丢包率等，它们也就成为了QoS的度量指标。



### 带宽

带宽也称为吞吐量，是指在一个固定的时间内（1秒），从网络一端传输到另一端的最大数据位数，也可以理解为网络的两个节点之间特定数据流的平均速率。带宽的单位是比特/秒（bit/s）。

在网络中，有两个常见的与带宽有关的概念：上行速率和下行速率。上行速率是指用户向网络发送信息时的数据传输速率，下行速率是指网络向用户发送信息时的传输速率。

例如，用户通过FTP上传文件到网络，影响上传文件速度的就是上行速率；而从网络下载文件，影响下载文件速度的就是下行速率。



### 时延

时延是指一个报文或分组从网络的发送端到接收端所需要的延迟时间，一般由传输延迟及处理延迟组成。以语音传输为例，时延是指从说话者开始说话到对方听到所说内容的时间。一般人们察觉不到小于100毫秒的延迟。

延迟在100毫秒和300毫秒之间时，说话者可以察觉到对方回复的轻微停顿，这种停顿可能会使通话双方都感觉到不舒服。超过300毫秒，延迟就会很明显，用户开始互相等待对方的回复。

当通话的一方不能及时接收到期望的回复时，说话者可能会重复所说的话，这样会与远端延迟的回复碰撞，导致重复。



### 抖动

如果网络发生拥塞，导致通过同一连接传输的分组延迟各不相同。抖动用来描述延迟变化的程度，也就是最大延迟与最小延迟的时间差。

抖动对于实时性的传输是一个重要参数，特别是语音和视频等实时业务是极不容忍抖动的，抖动会造成话音或视频的断续。抖动也会影响一些网络协议的处理。有些协议是按固定的时间间隔发送交互性报文，抖动过大会导致协议震荡。

所有传输系统都有抖动，只要抖动在规定容差之内就不会影响服务质量。利用缓存可以克服过量的抖动，但这将增加时延。



### 丢包率

丢包率是指在网络传输过程中丢失报文的数量占传输报文总数的百分比。少量的丢包对业务的影响并不大，例如，在语音传输中，丢失一个比特或一个分组的信息，通话双方往往注意不到。

在视频的传输中，丢失一个比特或一个分组可能造成在屏幕上瞬间的波形干扰，但能很快恢复正常。使用TCP传送数据可以处理少量的丢包，因为TCP允许丢失的信息重发。但大量的丢包会影响传输效率。

在QoS中，我们关注的是丢包的统计数据，也就是丢包率。所以正常传输时，网络丢包率应该控制在一定范围内即可。



https://support.huawei.com/enterprise/zh/doc/EDOC1100112412/b21640c0



# TC

tc全称为traffic control，是iproute2包中控制内核中流量的工具。

在内核网络协议栈中，专门有这样一个处理网络流量的地方（在XDP之后，netfilter之前），tc就是在这个地方读取网络数据包（此时已经是sk_buffer）进行控制、分发、丢弃等操作。

需要注意的是，tc既可以处理传出的数据包（egress），也可以处理传入的数据包（ingress），但对传入的数据包处理的功能较少。





TC模块实现流量控制功能使用的队列规定分为两类，一类是**无类队列规定**， 另一类是**分类队列规定**。 无类队列规定相对简单，而分类队列规定则引出了分类和过滤器等概念，使其流量控制功能增强。



流量的处理由三种对象控制，它们是：qdisc(排队规则)、class(类别)和filter(过滤器)。



### QDISCS

qdisc实际是`queueing discipline`的缩写，我们可以将其看作一个具有一定规则的队列。当tc处理网络包时，会将包入队到qdisc中，这些包会根据指定的规则被内核按照一定顺序取出。

tc中已经内置了很多不同的qdisc，有些qdisc可以带参数，比如ens33上面的qdisc参数是这样的。



```bash
root@server:/data/c# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: ens18: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether bc:24:11:28:bd:7a brd ff:ff:ff:ff:ff:ff
    altname enp0s18
    inet 192.168.2.103/24 brd 192.168.2.255 scope global ens18
       valid_lft forever preferred_lft forever
    inet6 fe80::be24:11ff:fe28:bd7a/64 scope link
       valid_lft forever preferred_lft forever
```

每个网络设备都在mtu后面都有一个qdisc，qdisc后面还有一个词，上面的lo的qdisc是noqueue，ens33的qdisc是fq_codel。







### CLASSES

有类qdisc可以有多个子类（class），有些qdisc预定义了子类（如prio），有些则需要用户添加类。一个类上又可以附加其他类。最末端没有子类的类称为叶子类，它上面附加了一个qdisc。当创建一个class的时候，默认会附加一个fifo qdisc，它只是一个简单的队列，不对数据包进行任何的操作。当在这个类上增加子类的时候，这个默认的qdisc被移除。你可以将这个默认的fifo qdisc替换成其他任意你想用的qdisc。

### FILTERS

过滤器，用于有类qdisc中，决定将包入队到哪个类中。每当一个包到达有子类的类时，就需要进行分类。其中一种分类的方法就是使用过滤器（另外两个是ToS和skb->priority）。所有附加到类上的过滤器会被依次调用，直到其中一个返回裁决。一个filter包含了一些条件，当一个包到达该节点时，会根据包的特征判断是否匹配。



# Linux iproute2



iproute2 是 Linux 用户空间下的一个网络工具集，它主要包含网络控制和流量管理等功能。包括：路由，网络接口，隧道，流量控制，网络相关的驱动。



iproute2 是linux下管理控制TCP/IP网络和流量控制的新一代工具包，旨在替代老派的工具链net-tools。即大家比较熟悉的 ifconfig，arp，route，netstat 等命令。

net-tools通过procfs(/proc)和 ioctl 系统调用去访问和改变内核网络配置，而 iproute2 则通过netlink套接字接口与内核通讯。

抛开性能而言，net-tools 的用法给人的感觉是比较乱，而 iproute2 的用户接口相对 net-tools 来说相对来说，更加直观。



比如，各种网络资源（如link、IP地址、路由和隧道等）均使用合适的对象抽象去定义，使得用户可使用一致的语法去管理不同的对象.



iproute2 是一个基于 GPLv2 协议开源的项目。它的开发跟 Linux 内核中的网络组件的开发紧密相关。

2013年12月，它主要由 Stephen Hemminger and David Ahern 来维护。它的创始人现在在负责 Linux 内核的 QoS 。

iproute2 工具集包含如下命令：

- arpd                    
- bridge
- ctstat
- devlink
- ip
- lnstat
- nstat 
- rdma
- routef
- routel
- rtacct
- rtmon
- rtstat
- ss
- tc 
- tipc 











|      |          |      |      |      |
| ---- | -------- | ---- | ---- | ---- |
|      | ifconfig |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |
|      |          |      |      |      |



