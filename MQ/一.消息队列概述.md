# 消息队列概述





**消息**

“消息”是在两台计算机间传送的数据单位。

消息可以非常简单，例如只包含文本字符串；也可以更复杂，可能包含嵌入对象。



**队列**

队列(Queue)队列是一种先进先出(FIFO)的数据结构。



**消息队列**

消息队列是一个存放消息的容器，消息队列是分布式系统中的重要组件，使用消息队列主要是为了**通过异步处理提高系统性能、削峰、降低系统耦合性**。



https://github.com/aCoder2013/blog/issues/23



## 消息队列的使用场景

消息队列的三大特性：解耦，削峰，异步



- **项目解耦**：不同的项目或模块可以使用消息中间件进行数据的传递，从而可以保证模块的相对独立，实现解耦。
  - 有了消息队列，订单系统和库存系统都和消息队列打交道，所以完全解耦了。
- **流量削峰**：可以将突发的流量 (如秒杀数据) 写入消息中间件，然后由多个消费者进行异步处理。
- **弹性伸缩**：可以通过对消息中间件进行横向扩展来提高系统的处理能力和吞吐量。
- **发布订阅**：可以用于任意的发布订阅模式中。
- **异步处理**：当我们不需要对数据进行立即处理，或者不关心数据的处理结果时，可以使用中间件进行异步处理。
- **冗余存储**：消息中间件可以对数据进行持久化存储，直到你消费完成后再进行删除。







假设用户在你的软件中注册，服务端收到用户的注册请求后，它会做这些操作：

1. 校验用户名等信息，如果没问题会在数据库中添加一个用户记录
2. 如果是用邮箱注册会给你发送一封注册成功的邮件，手机注册则会发送一条短信
3. 分析用户的个人信息，以便将来向他推荐一些志同道合的人，或向那些人推荐他
4. 发送给用户一个包含操作指南的系统通知
5. 等等……



但是对于用户来说，注册功能实际只需要第一步，只要服务端将他的账户信息存到数据库中他便可以登录上去做他想做的事情了。

至于其他的事情，非要在这一次请求中全部完成么？值得用户浪费时间等你处理这些对他来说无关紧要的事情么？

所以实际当第一步做完后，服务端就可以把其他的操作放入对应的消息队列中然后马上返回用户结果，由消息队列异步的进行这些操作。

还有一种情况，同时有大量用户注册你的软件，再高并发情况下注册请求开始出现一些问题，例如邮件接口承受不住，或是分析信息时的大量计算使cpu满载，这将会出现虽然用户数据记录很快的添加到数据库中了，但是却卡在发邮件或分析信息时的情况，导致请求的响应时间大幅增长，甚至出现超时，这就有点不划算了。面对这种情况一般也是将这些操作放入消息队列（生产者消费者模型），消息队列慢慢的进行处理，同时可以很快的完成注册请求，不会影响用户使用其他功能。

在软件的正常功能开发中，并不需要去刻意的寻找消息队列的使用场景，而是当出现性能瓶颈时，去查看业务逻辑是否存在可以异步处理的耗时操作，如果存在的话便可以引入消息队列来解决。否则盲目的使用消息队列可能会增加维护和开发的成本却无法得到可观的性能提升，那就得不偿失了。







引入消息队列，实际上提高了很高的复杂度。需要考虑各种问题：



- 消息是否有考虑有序性
- 消息可靠性









https://github.com/doocs/advanced-java/blob/main/docs/high-concurrency/why-mq.md

## AMQP协议

AMQP (Advanced Message Queuing Protocol) 是一个提供统一消息服务的应用层通讯协议，为消息中间件提供统一的开发规范。

不同客户端可以将消息投递到消息队列中间件上，或从上面获取消息；发送消息和接收消息的客户端可以采用不同的语言开发、不同的技术实现，但必须遵循相同的 AMQP 协议。AMQP 协议本身包括以下三层：

- **Module Layer**：位于协议最高层，主要定义了一些供客户端调用的命令，客户端可以利用这些命令实现自己的业务逻辑。
  - 例如：可以使用 Queue.Declare 命令声明一个队列或者使用 Basic.Consume 订阅消费一个队列中的消息。
- **Session Layer**：位于中间层，主要负责将客户端的命令发送给服务器，再将服务端的应答返回给客户端，主要为客户端与服务器之间的通信提供可靠性同步机制和错误处理。
- **Transport Layer**：位于最底层，主要传输二进制数据流 ，提供帧的处理、信道复用、错误检测和数据表示等。





