# WAF概述





> 
>
> Web应用防护系统（也称为：网站应用级入侵防御系统。英文：Web Application Firewall，简称： WAF）。
>
> 利用国际上公认的一种说法：Web应用防火墙是通过执行一系列针对HTTP/HTTPS的安全策略来专门为Web应用提供保护的一款产品。
>
> Web应用防火墙（Web Application Firewall，简称  WAF）为您的网站或App业务提供一站式安全防护。
>
> WAF可以有效识别Web业务流量的恶意特征，在对流量进行清洗和过滤后，将正常、安全的流量返回给服务器。
>
> 避免网站服务器被恶意入侵导致服务器性能异常等问题，保障网站的业务安全和数据安全。



**WAF 主要功能**

- 提供Web应用攻击防护。
- 缓解恶意CC攻击，过滤恶意的Bot流量，保障服务器性能正常。
- 提供业务风控方案，解决业务接口被恶意滥刷等业务安全风险。
- 提供网站一键HTTPS和HTTP回源，降低源站负载压力。
- 支持对HTTP和HTTPS流量进行精准的访问控制。
- 支持超长时长的全量日志实时存储、分析和自定义报表服务，支持日志线上同步第三方平台，助力满足等保合规要求。

[阿里云WAF](https://help.aliyun.com/document_detail/149485.html?spm=a2c4g.11186623.6.577.4dc842eauvprOo)

常见Web应用攻击防护

- 防御OWASP常见威胁：支持防御以下常见威胁：
  - SQL注入
  - XSS跨站
  - Webshell上传
  - 后门隔离保护
  - 命令注入
  - 非法HTTP协议请求
  - 常见Web服务器漏洞攻击
  - 核心文件非授权访问
  - 路径穿越
  - 扫描防护等。
- 网站隐身：不对攻击者暴露站点地址、避免其绕过Web应用防火墙直接攻击。
- 0day补丁定期及时更新：防护规则与淘宝同步，及时更新最新漏洞补丁，第一时间全球同步下发最新补丁，对网站进行安全防护。
- 友好的观察模式：针对网站新上线的业务开启观察模式，对于匹配中防护规则的疑似攻击只告警不阻断，方便统计业务误报状况。





Web Application Firewall ,可以用来屏蔽常见的网站漏洞攻击，如SQL注入，XML注入、XSS等。

一般针对的是应用层而非网络层的入侵，从技术角度应该称之为Web IPS。其防护重点是SQL注入。

 Web防火墙产品部署在Web服务器的前面，串行接入，不仅在硬件性能上要求高，而且不能影响Web服务，所以HA功能、Bypass功能都是必须的，而且还要与[负载均衡](https://link.zhihu.com/?target=https%3A//www.imperva-incapsula.cn/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/)、Web Cache，CDN等Web服务器前的常见的产品协调部署。

 

[Web应用防火墙](https://link.zhihu.com/?target=https%3A//www.imperva-incapsula.cn/%E7%BD%91%E7%AB%99%E5%AE%89%E5%85%A8/waf/)的主要技术的对入侵的检测能力，尤其是对Web服务入侵的检测，Web防火墙最大的挑战是识别率，这并不是一个容易测量的指标，因为漏网进去的入侵者，并非都大肆张扬，比如给网页挂马，你很难察觉进来的是那一个，不知道当然也无法统计。对于已知的攻击方式，可以谈识别率;对未知的攻击方式，你也只好等他自己“跳”出来才知道。

 现在市场上大多数的产品是基于规则的WAF。其原理是每一个会话都要经过一系列的测试，每一项测试都由一个过多个检测规则组成，如果测试没通过，请求就会被认为非法并拒绝。

基于规则的WAFs很容易构建并且能有效的防范已知安全问题。当我们要制定自定义防御策略时使用它会更加便捷。

但是因为它们必须要首先确认每一个威胁的特点，所以要由一个强大的规则数据库支持。WAF生产商维护这个数据库，并且他们要提供自动更新的工具。

 这个方法不能有效保护自己开发的WEB应用或者零日漏洞（攻击者使用的没有公开的漏洞），这些威胁使用基于异常的WAF更加有效。

 

异常保护的基本观念是建立一个保护层，这个保护层能够根据检测合法应用数据建立统计模型，以此模型为依据判别实际通信数据是否是攻击。理论上，一但构建成功，这个基于异常的系统应该能够探测出任何的异常情况。拥有了它，我们不再需要规则数据库而且零日攻击也不再成问题了。但基于异常保护的系统很难构建，所以并不常见。因为用户不了解它的工作原理也不相信它，所以它也就不如基于规则的WAF应用广范。

 

Imperva公司的WAF产品在提供入侵防护的同时，还提供了另外一个安全防护技术，就是对Web应用网页的自动学习功能，由于不同的网站不可能一样，所以网站自身页面的特性没有办法提前定义，所以imperva采用设备自动预学习方式，从而总结出本网站的页面的特点。具体的做法是这样的：

 

通过一段时间的用户访问，WAF记录了常用网页的访问模式，如一个网页中有几个输入点，输入的是什么类型的内容，通常情况的长度是多少…学习完毕后，定义出一个网页的正常使用模式，当今后有用户突破了这个模式，如一般的帐号输入不应该有特殊字符，而XML注入时需要有“<”之类的语言标记，WAF就会根据你预先定义的方式预警或阻断;再如密码长度一般不超过20位，在SQL注入时加入代码会很长，同样突破了网页访问的模式。

 

网页自学习技术，从Web服务自身的业务特定角度入手，不符合我的常规就是异常的，也是入侵检测技术的一种，比起单纯的Web防火墙来，不仅给入侵者“下通缉令”，而且建立进入自家的内部“规矩”，这一种双向的控制，显然比单向的要好。

 

















# openresty安装





# WAF部署



```shell
git clone https://github.com/unixhot/waf.git

cp -r ./waf/waf /usr/local/openresty/nginx/conf/

vim /usr/local/openresty/nginx/conf/nginx.conf
#在http{}中增加，注意路径，同时WAF日志默认存放在/tmp/日期_waf.log
#WAF
lua_shared_dict limit 50m;
lua_package_path "/usr/local/openresty/nginx/conf/waf/?.lua";
init_by_lua_file "/usr/local/openresty/nginx/conf/waf/init.lua";
access_by_lua_file "/usr/local/openresty/nginx/conf/waf/access.lua";


```

