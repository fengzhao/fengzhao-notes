# IPv4协议和NAT的由来



今天，无数快乐的互联网用户在尽情享受Internet带来的乐趣。他们浏览新闻，搜索资料，下载软件，广交新朋，分享信息，甚至于足不出户获取一切日用所需。企业利用互联网发布信息，传递资料和订单，提供技术支持，完成日常办公。

然而，Internet在给亿万用户带来便利的同时，自身却面临一个致命的问题：构建这个无所不能的Internet的基础IPv4协议已经不能再提供新的网络地址了。





IPv4即网际网协议第4版——Internet Protocol Version 4的缩写。IPv4定义一个跨越异种网络互连的超级网，它为每个网际网的节点分配全球唯一IP地址。

如果我们把Internet比作一个邮政系统，那么IP地址的作用就等同于包含城市、街区、门牌编号在内的完整地址。IPv4使用32bits整数表达一个地址，地址最大范围就是232 约为43亿。

以IP创始时期可被联网的设备来看，这样的一个空间已经很大，很难被短时间用完。然而，事实远远超出人们的设想，计算机网络在此后的几十年里迅速壮大，网络终端数量呈爆炸性增长。



[RFC2663](https://datatracker.ietf.org/doc/html/rfc2663#section-4.0) 把 NAT 分成了四类：传统 NAT、双向 NAT、两次 NAT、多宿主 NAT。





根据NAT转换是对报文中的源地址进行转换还是对目的地址进行转换，NAT可以分为SNAT、DNAT和双向NAT





### SNAT

源NAT在NAT转换时，仅对报文中的源地址进行转换，主要应用于私网用户访问公网的场景。当私网用户主机访问Internet时，私网用户主机发送的报文到达NAT设备后，设备通过源NAT技术将报文中的私网IPv4地址转换成公网IPv4地址，从而使私网用户可以正常访问Internet。





### 基本NAT



现在一般都是分配私有IP给普通用户。可以看看自己的路由器WAN口是不是属于10.0.0.0/8，172.16.0.0/12、192.168.0.0/16或100.64.0.0/10。

如果是，那运营商分配给你的就是私有地址。



但是互联网主要发展于欧美，因此许多欧美的组织与机构在初期被分配了大量的 IPv4 资源，而后入场的中国分配到的 IPv4 地址就不太能匹配上我们的人口。 

因此相比欧美，中国的 IPv4 地址是非常短缺的，即使使用上述这样的网络架构——也就是给每个家庭（或组织）分配一个 IPv4 地址——都有点捉襟见肘了。 

于是中国电信等国内运营商不得不再加一层 NAT，让多个家庭共用同一个 IP 地址，这时网络架构会变成这样：

「家庭局域网」=>「家庭 NAT 网关」=>「运营商广域网」=>「运营商 NAT 网关」=>「公共因特网」。 

由于此架构通过两层 NAT 网关串联了三个不同的 IPv4 网络，它也被形象地称为 NAT444 技术。





对于IPv4业务，通过两级NAT44实现承载，级NAT44是在家庭网络CPE侧，实现用户私有IPv4地址到运营私有IPv4地址的映射，模式是1:1映射，第二级NAT44是在网络的LSN(Large Sacle NAT)，实现运营私有IPv4地址到公网IPv4地址的映射，模式是N:1映射