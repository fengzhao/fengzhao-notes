# 组复制背景

http://www.woqutech.com/docs_info.php?id=508



创建容错系统最常见的方法是对组件进行冗余。

换句话说，在系统正常运行过程中，删除某个组件之后系统应该按照预期正常继续运行，而不会对系统的可用性造成影响。



这就带来了一系列挑战，要实现此类系统，与不具备容错能力的系统相比，这会将系统的复杂性提高到一个完全不同的水平。



具体来说，复制拓扑中需要管理和维护多个组成员，而不仅仅是一个组成员，此外，由于组成员之间需要协同工作，因此，还必须要解决分布式系统中的其他几个典型的分布式问题，例如：网络分区或脑裂等场景。



因此，最大的挑战是将数据库和数据复制的逻辑与以一致且简单的方式协调多个组成员的逻辑结合起来。

换句话说，让多个组成员就系统的运行状态、系统中每次有数据变更时状态达成一致。

这可以概括为让组成员在发生任何数据库状态变化时都达成一致（从而使得它们看上去像是作为一个单一的数据库运行的）或者所有组成员能够收敛到一个最终一致性状态。这意味着它们都需要作为（分布式）状态机运行。





组复制为分布式状态机复制提供了强大的组成员间的协作能力。当所有Server节点都属于同一个组时，它们通过分布式状态机自动协调自己。

组可以运行在单主模式下，也可以运行在多主模式下，在多主模式下，即使在所有组成员中发起并行更新操作。这种分布式协调能力，也可以使得这些并发请求能够正常执行，而不至于产生数据冲突。





在组复制中要提交事务，组内的大多数成员必须就全局事务序列中给定的事务顺序达成一致。每个组成员单独决定是否提交或中止事务（每个组成员各自按照相同的顺序对事务进行冲突认证检测），但是所有组成员都最终都会做出相同的决定。

如果存在网络分区，导致出现了组成员无法达成一致意见的分裂，则在解决网络分区问题之前，系统会发生阻塞（不会继续向前执行）。因此，组复制 支持一种内置的自动裂脑保护机制来防止发生网络分区时，可能导致数据不一致的问题。



以上提到的所有这些特性，都是由组通信系统(GCS)协议提供支持的。它们提供了故障检测机制、组成员服务以及安全且完全有序的消息传递。所有这些属性对于创建一个可确保跨组成员且能够一致地复制数据的系统中非常关键。该技术的核心是Paxos算法的实现。它充当着组通信引擎的角色。



















> 数据库架构设计中的三种模式
>
> Shared Everthting:一般是针对单个主机，完全透明共享CPU/MEMORY/IO，并行处理能力是最差的。















# 组复制



组复制(Group Replication)是一种可用于实现容错系统的技术。复制组是一组MySQL Server，每个Server都有自己的数据完整副本(shared-nothing复制方案)，并通过组通讯消息传递进行相互交互。



组通信层提供一组保证，例如：保证消息的原子性和消息在所有组成员的整体顺序一致。这些属性非常强大，可以转换为非常有用的抽象概念，可以采用这些抽象概念来构建更高级的数据库复制解决方案。



组复制建立在这些属性和抽象概念的基础上，并实现了基于主从复制协议的多主模式（多主模式下任意组成员都可更新数据）。复制组由多个MySQL Server组成，组中的每个成员可以在任何时候独立执行事务。但是，所有读写事务（不包含只读事务）只有在得到复制组的批准之后才能提交（通过冲突认证检测之后才能提交）。换句话说，对于任何读写事务，都是由组来决定它是否可以提交，而不是由发起事务提交的原始组成员单方面决定。如果是只读事务，则不需要在组内进行协调，可以立即提交（即，发起事务的组成员可以单方面决定）。







## 单主模式



在单主模式下(group_replication_single_primary_mode=ON)，组中只有一个成员设置为读写模式（称为"主要节点"）。组中的其他所有成员都设置为只读模式（称为"辅助节点"）。主要节点通常是引导组启动的第一个MySQL Server。加入组的所有其他MySQL Server将学习主要节点（从主要节点同步数据），并自动设置为只读模式。



在单主模式下，组复制强制约束组内只有一个成员可以执行写操作，因此与多主模式相比，一致性检查可以不那么严格，而且不需要特别小心地处理DDL语句。系统变量 group_replication_enforce_update_everywhere_checks 用于启用或禁用组的严格一致性检查功能。当以单主模式部署或将组模式更改为单主模式时，必须将该系统变量设置为OFF，以关闭严格一致性检查。



## 多主模式