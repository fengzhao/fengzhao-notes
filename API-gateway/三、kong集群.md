# Kong集群





kong 集群将使得系统通过增加更多机器，从而实现水平扩展，承接更多的请求流量。它们将共享同样的配置且使用同一个数据库。kong 集群中的的所有节点都连接同一个数据库。

你需要在 kong 集群的上一层架设一个负载均衡的代理服务器，以便请求能够平均分散转发到 kong 的各个节点上。







拥有 Kon g群集并不意味着客户端流量将在开箱即用的 Kong 节点中实现负载平衡，仍然需要在 Kong 节点前面使用负载平衡器来分配流量。相反，Kong 群集意味着这些节点将共享相同的配置。

出于性能原因，Kong在代理请求时避免数据库连接，并将数据库的内容缓存到内存中。cached实体包括services，routes，consumers，plugins，credentials等

由于这些值在内存中，因此通过其中一个节点的Admin API进行的任何更改都需要传播到其他节点。





## 单点Kong集群



只有一个 kong 节点连接数据库（Cassandra或PostgreSQL）的单节点 kong 集群，任何通过 Admin api 的更改，都会立即全局生效。比如：

假设只有一个kong单节点A ，如果我们删除一个已经注册的Service：

```shell
$ curl -X DELETE http://127.0.0.1:8001/services/test-service
```

随后任何关于 kong节点A 请求都将会返回 “404 Not Found”，因为该节点已经在本地删除中清除了缓存。

```shell
$ curl -i http://127.0.0.1:8000/test-service
```





## 多节点Kong集群



在一个多节点 kong 集群中，当我们通过 A 节点的 Admin api 删除某条信息，其他节点虽然都连接同一个数据库，但由于本地缓存存在，所以并不会立即生效。

虽然 API 不再存储在数据库中（通过A 节点的 Admin api 删除的），但它仍然存在 B以及其他节点的内存中。

所有节点将会周期性执行后台同步任务，同步其他节点触发的变化。该同步任务执行频率可以通过配置下面的配置项：

```shell
db_update_frequency (默认: 5 秒)
```

每 db_update_frequency 秒，所有 kong 节点将从数据库中拉取所有更新，如果有同步到更新变化，将清理本地相关缓存。

如果我们通过 kong-A 节点删除一个 API，这个更新变化将不会立即在 B 节点生效，直到 B 节点下一次从数据库拉取变更，这将会是在db_update_frequency 秒后才会发生（也有可能会更早）。

这个过程将会使 kong 集群最终保持一致性。





## 什么是缓存

所有核心实体（如服务，路由，插件，消费者，凭证）都由Kong存储在内存中，缓存失效则依赖后台任务同步更新。

此外，kong 也会缓存数据库遗漏（数据库中有的数据，但本地不存在的）。这意味着如果你配置一个没有插件的服务，Kong会缓存这些信息。例：



