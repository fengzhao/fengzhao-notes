





在云计算时代，虚拟机和容器已经成为标配。

它们背后的网络管理都离不开一样东西，就是虚拟网络设备，或者叫虚拟网卡，tap/tun 就是在云计算时代非常重要的虚拟网络网卡。







tap/tun 是 Linux 内核 2.4.x 版本之后实现的虚拟网络设备，不同于物理网卡靠硬件网路板卡实现。

tap/tun 虚拟网卡完全由软件来实现，功能和硬件实现完全没有差别，它们都属于网络设备，都可以配置 IP，都归 Linux 网络设备管理模块统一管理。

作为网络设备，tap/tun 也需要配套相应的驱动程序才能工作。tap/tun 驱动程序包括两个部分，一个是字符设备驱动，一个是网卡驱动。

这两部分驱动程序分工不太一样，字符驱动负责数据包在内核空间和用户空间的传送，网卡驱动负责数据包在 TCP/IP 网络协议栈上的传输和处理。







## veth

veth 是另一种主流的虚拟网卡方案，在 Linux Kernel 2.6 版本，Linux 开始支持网络名空间隔离的同时。也提供了专门的虚拟以太网（Virtual Ethernet，习惯简写做 veth）让两个隔离的网络名称空间之间可以互相通信。veth 实际上不是一个设备，而是一对设备，因而也常被称作 Veth-Pair。



Docker 中的 Bridge 模式就是依靠 veth-pair 连接到 docker0 网桥上与宿主机乃至外界的其他机器通信的。





## 虚拟机交换机/网桥

在物理机的网络环境中，多台不同的物理机之间是如何连接一起互相通信的呢？ 没错，那就是以太网交换机。

同一网络内的多台物理机通过交换机连在一起，然后它们就可以相互通信了。



在网络虚拟化环境里，和物理网络中的交换机一样，也需要这样的一个软件实现的设备。

它需要有很多个虚拟端口，能把更多的虚拟网卡连接在一起，通过自己的转发功能让这些虚拟网卡之间可以通信。 

在 Linux 下这个软件实现交换机的技术就叫做 bridge（再强调下，这是纯软件实现的）。

 

## 用户空间与内核空间的数据传输



在 Linux 中，用户空间和内核空间的数据传输有多种方式，字符设备就是其中的一种。

tap/tun 通过驱动程序和一个与之关联的字符设备，来实现用户空间和内核空间的通信接口。