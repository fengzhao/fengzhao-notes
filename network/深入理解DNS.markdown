# DNS原理





域名系统（DNS）是互联网的地址簿。当您访问 cloudflare.com 或任何其他站点时，您的浏览器将向DNS解析器询问可以找到站点的IP地址。











递归解析/递归查询



这种是最常见，**也是默认的解析方式**。

在这种解析方式中，如果客户端配置的本地名称服务器，**（又称Local DNS， 可以是默认的运营商提供的Local DNS 或者自己设置的其他公共DNS）** 。

**如果不能解析的话，则后面的查询全由本地名称服务器代替DNS客户端进行查询**，直到本地名称服务器从权威名称服务器得到了正确的解析结果。

然后由本地名称服务器告诉DNS客户端查询的结果。



在这个查询过程中，一直是以 Local DNS 为中心的，DNS客户端只是发出原始的域名查询请求报文，然后就一直处于等待状态的，直到本地名称服务器发来了最终的查询结果。此时的本地名称服务器就相当于中介代理的作用。

如果考虑了  Local DNS  的缓存技术（也就是在  Local DNS 上对一定数量的以前查询记录保存一定时间，这样后面查询同样的域名信息时就可直接从缓存中调出来，以加速查询效率）的话。（）



（1）客户端向本机配置的  Local DNS （在此仅以首选DNS服务器为例进行介绍，所配置其它备用DNS服务器的解析流程完全一样）发出DNS域名查询请求。

（2）  Local DNS  收到请求后，先查询本地的缓存，如果有该域名的记录项，则   Local DNS  就直接把查询的结果返回给客户端；如果本地缓存中没有该域名的记录，则   Local DNS  再以DNS客户端的角色发送与前面一样的DNS域名查询请求发给**根名称服务器**。

（3）根名称服务器收到DNS请求后，把所查询得到的所请求的DNS域名中**顶级域名所对应的顶级名称服务器**地址返回给  Local DNS  。

（4）  Local DNS 根据根名称服务器所返回的顶级名称服务器地址，向对应的顶级名称服务器发送与前面一样的DNS域名查询请求。

（5）对应的顶级名称服务器在收到DNS查询请求后，也是先查询自己的缓存，如果有所请求的DNS域名的记录项，则相接把对应的记录项返回给本地名称服务器，然后再由本地名称服务器返回给DNS客户端，否则向本地名称服务器返回所请求的DNS域名中的二级域名所对应的二级名称服务器地址。

然后本地名称服务器继续按照前面介绍的方法一次次地向三级、四级名称服务器查询，直到最终的对应域名所在区域的**权威名称服务器**返回到最终的记录给本地名称服务器。然后再由本地名称服务器返回给DNS客户，同时本地名称服务器会缓存本次查询得到的记录项。





























# DoH与DoT





DoT 全称是 DNS over TLS，它使用 TLS 协议来传输 DNS 协议。TLS 协议是目前互联网最常用的安全加密协议之一，我们访问 HTTPS 的安全基础就是基于 TLS 协议的。相比于之前使用无连接无加密的 UDP 模式， TLS 本身已经实现了保密性与完整性。

DoH全称是DNS over HTTPS，它使用 HTTPS 来传输 DNS 协议。DoH 的安全原理与 DoT 一样，他们之间的区别只在于：DoH有了 HTTP 格式封装，更加通用。

DoT在专用端口上通过 TLS 连接 DNS 服务器，而 DoH 是基于使用 HTTP 应用程序层协议，将查询发送到 HTTPS 端口上的特定 HTTP 端点,这里造成的外界感知就是端口号的不同，DoT 的端口号是 853，DoH 端口号 443。









阿里云公共DNS安全传输服务介绍（DoH/DoT）

https://www.alidns.com/articles/6018321800a44d0e45e90d71



目前已经DoT/DoH方案已经正式开放公测：为DNSPod用户的信息和隐私安全保驾护航。

- DoH 地址：https://doh.pub/dns-query
- DoT 地址：dot.pub



